# This is a basic workflow that is manually triggered

name: sisu-e2e

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  push:
    branches:
      - master
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - edited
      - ready_for_review
      - converted_to_draft

concurrency:
  group: ci-tests-${{ github.ref }}-1
  cancel-in-progress: true

# This workflow makes x86_64 binaries for mac, windows, and linux.

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    steps:
      
      - uses: actions/checkout@master
        with:
          repository: sisu-network/sisu
          path: ./sisu
      
      - uses: actions/checkout@master
        with:
          repository: sisu-network/deyes
          path: ./deyes
      
      - uses: actions/checkout@master
        with:
          repository: sisu-network/dheart
          path: ./dheart          
    
      - name: Show Working directory
        run: ls -al

      - name: Build sisu, dheart & deyes images
        working-directory: ./sisu
        run: |
          ./scripts/docker_build_all.sh
          docker images

      - name: Setup go
        uses: actions/setup-go@v1
        with:
          go-version: 1.16
        env:
          GOOS: ${{ matrix.targetos }}
          GOARCH: ${{ matrix.arch }}

      - name: Build sisu and generate  test data for local docker
        working-directory: ./sisu
        run: |
          cp .env.dev .env
          go build -o ./sisu cmd/sisud/main.go
          ./sisu local-docker --v 2 --output-dir ./output
        env:
          GO111MODULE: on
          GOSUMDB: off

      - name: Start docker-compose stack
        working-directory: ./sisu/output
        run: |
          docker-compose up -d
          docker-compose ps --services --filter "status=running"

      - name: Fund account
        working-directory: ./sisu
        run: |
          echo "./sisu dev fund-account ganache1 7545 ganache2 8545 100"
          fund=$(./sisu dev fund-account ganache1 7545 ganache2 8545 100)
          echo "$fund" | grep 'Transfer ERC20 token done' || (echo "$fund" && exit 1)

      - name: Token Swap
        working-directory: ./sisu
        run: |
          echo "./sisu dev swap --token SISU --amount 10 --recipient 0x2d532C099CA476780c7703610D807948ae47856A"
          swap=$(./sisu dev swap --token SISU --amount 10 --recipient 0x2d532C099CA476780c7703610D807948ae47856A)
          echo "$swap" | grep 'destination = ganache2, recipientAddr 0x2d532C099CA476780c7703610D807948ae47856A, srcTokenAddr = 0xf0D676183dD5ae6b370adDdbE770235F23546f9d, dstTokenAddr = 0xf0D676183dD5ae6b370adDdbE770235F23546f9d, amount = 10000000000000000000' || (echo "$swap" && exit 1)

      - name: Token Query
        working-directory: ./sisu
        run: |
          echo "./sisu dev query --token SISU --src ganache2 --account 0x2d532C099CA476780c7703610D807948ae47856A"
          query=$(./sisu dev query --token SISU --src ganache2 --account 0x2d532C099CA476780c7703610D807948ae47856A)
          echo "$query"
